<!-- 班级设置  -->
<template>
	<div class="clazzSetting">
		<el-row class='rowTop'>
      <el-col :span='16'>
        <el-form inline :model='cla' size='mini'>
          <el-row>
            <el-col :span='6'>
              <el-form-item label=''>
                <el-select clearable v-model="cla.grade_id" placeholder="请选择年级">
                  <el-option v-for="item in grades" :label="item.grade_name" :value="item.grade_id" :key="item.grade_id">
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span='6'>
              <el-form-item>
                <el-button type='info' size='small' @click='query' class="search"><!-- <i class="fa fa-search"></i> --> &nbsp;查询</el-button>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </el-col>
			<el-col :span='8'>
        <el-row type='flex' justify='end'>
          <el-form inline size='mini'>
            <el-col :span='12'>
              <el-form-item class='but'>
                <el-button type='info' size='small' @click='add4' class="add"><!-- <i class="fa fa-plus"></i> -->新增班级</el-button>
              </el-form-item>
            </el-col>
            <el-col :span='12'>
              <el-form-item class='but'>
                <el-button type='info' size='small' @click='batch4' class="adds"><!-- <i class="fa fa-plus-circle"></i> -->批量新增</el-button>
              </el-form-item>
            </el-col>
          </el-form>
        </el-row>
			</el-col>
		</el-row>
    <el-table :data="clazz" class='table' border stripe :header-row-style="rowClass" size='mini' :height='height'>
      <el-table-column type="index" fixed label="序号" align='center'></el-table-column>
      <el-table-column prop="class_id" label="id" fixed v-if='false' align='center'>
      </el-table-column>
      <el-table-column prop="class_name1" label="班级名称" fixed v-if='false' align='center'></el-table-column>
      <el-table-column prop="grade_id" label="年级id" fixed v-if='false' align='center'></el-table-column>
      <el-table-column prop="grade_name" label="年级名称" width='110' fixed align='center'></el-table-column>
      <el-table-column prop="class_name" label="班级名称" fixed align='center'></el-table-column>
      <el-table-column prop="class_abbreviation" label="班级简称" fixed align='center'></el-table-column>
      <el-table-column prop="teach_id" label="班主任id" fixed v-if='false' align='center'></el-table-column>
      <el-table-column prop="teach_name" label="班主任" fixed align='center'></el-table-column>
      <el-table-column v-for='item in rateClazzSetting' :key='item.name' :prop="item.prop" :label="item.name" width='120' align='center'></el-table-column>
      <el-table-column prop="class_status" label="状态" fixed='right' width='80' align='center'></el-table-column>
      <el-table-column label="操作" fixed='right' width='80' align='center'>
        <template slot-scope='scope'>
          <i class="options fa fa-edit" @click="edit4(scope.$index, scope.row)"></i>
	        <i class="options fa fa-trash" @click="delete4(scope.$index, scope.row)"></i>
        </template>
      </el-table-column>
    </el-table>

    <el-dialog :visible.sync="visible4" center>
      <div slot="title" class="dialog-title">
        {{title4}}
      </div>
      <el-form :model="form4" :rules='rules' class='demo-ruleForm dialog' ref='form4' size='mini'>
        <el-row>
          <el-col :span='12'>
            <el-form-item label="班主任姓名" :label-width="fw" prop='teach_id'>
              <el-select v-model="form4.teach_id" placeholder="请选择班主任" style="width: 100%">
                <el-option v-for="item in teachs" :label="item.teach_name" :value="item.teach_id" :key="item.teach_id"></el-option>
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span='12'>
            <el-form-item label="年级名称" :label-width="fw" prop='grade_id'>
              <el-select v-model="form4.grade_id" placeholder="请选择年级" style="width: 100%">
                <el-option v-for="item in grades" :label="item.grade_name" :value="item.grade_id" :key="item.grade_id"></el-option>
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span='12'>
            <el-form-item label="班级序号" :label-width="fw">
              <el-input v-model="form4.class_no" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span='12'>
            <el-form-item label="班级名称" :label-width="fw" prop='class_name'>
              <el-input v-model="form4.class_name" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span='12'>
            <el-form-item label="班级简称" :label-width="fw" prop='class_abbreviation'>
              <el-input v-model="form4.class_abbreviation" auto-complete="off"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span='12' v-for='item,i in rateClazzSetting' :key='item.name'>
            <el-form-item :label="item.name" :label-width="fw" :prop='item.prop'>
              <el-input auto-complete="off" v-model='form4[item.prop]' @blur="heartRateCheck(i,form4[item.prop])"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span='12'>
            <el-form-item label="启用状态" :label-width="fw" prop='class_status'>
              <el-radio-group v-model="form4.class_status">
                <el-radio label="启用">启用</el-radio>
                <el-radio label="禁用">禁用</el-radio>
              </el-radio-group>
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="cancle4" size='mini'>取 消</el-button>
        <el-button type="info" @click="submit4('form4')" class="yes" size='mini'>确 定</el-button>
      </div>
    </el-dialog>
    <el-dialog :visible.sync="visible4s" center>
      <div slot="title" class="dialog-title">
        {{title4s}}
      </div>
      <el-form :model="form4s" class='dialog4' size='mini'>
        <el-form-item label="批量新增班级" :label-width="fw">
          <el-input placeholder="请输入班级数量" v-model="form4s.class_num" style='width:92%'></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="cancle4s" size='mini'>取 消</el-button>
        <el-button type="info" @click="submit4s" class="yes" size='mini'>确 定</el-button>
      </div>
    </el-dialog> 
	</div>
</template>

<script type="text/javascript">
import {mapActions,mapGetters} from 'vuex';
import $ from 'jquery';

export default {
  name: 'clazzSetting',
  data(){
    return {
      fw:'100px',
      title4:'班级',
      title4s:'批量添加班级',
      cla:{},
      height:0,
      form4:{},
      form4s:{},
      visible4:false,
      visible4s:false,
      rules:{
        teach_id:[
          {required:true,message:'请选择班主任',trigger: 'change'},
        ],
        grade_id:[
          {required:true,message:'请选择年级',trigger: 'change'},
        ],
        class_name:[
          {required:true,message:'请输入班级名称',trigger: 'blur'},
        ],
        class_abbreviation:[
          {required:true,message:'请输入班级简称',trigger: 'blur'},
        ],
        class_status:[
          {required:true,message:'请选择启用状态',trigger: 'change'},
        ],
      },
    }
  },
  created(){
    this.findAllClazz();
    this.height = $(window).height()-256;//应对于不同的分别率。
    this.findRateNameClazz();
  },
  computed:{
    ...mapGetters(['clazz','grades','teachs','rateClazzSetting']),
  },
  methods:{
    heartRateCheck(i,value){
    //最低、最高、平均心率校验：
      let a = this.form4[this.rateClazzSetting[0].prop];
      let b = this.form4[this.rateClazzSetting[1].prop];
      let c = this.form4[this.rateClazzSetting[2].prop];
      if(i == 0){
        if(c){//非空。
          if(+value > +c){
            this.$notify({type:'info',message:'最低心率应小于平均心率，请您重新设置！'}); 
            this.form4[this.rateClazzSetting[0].prop] = '';
          }
        }
        if(b){
          if(+value > +b){
            this.$notify({type:'info',message:'最低心率应小于最高心率，请您重新设置！'}); 
            this.form4[this.rateClazzSetting[0].prop] = '';
          }
        }
      }else if(i == 1){
        if(c){
          if(+value < +c){
            this.$notify({type:'info',message:'最高心率应大于平均心率，请您重新设置！'}); 
            this.form4[this.rateClazzSetting[1].prop] = '';
          }
        }
        if(a){
          if(+value < +a){
            this.$notify({type:'info',message:'最高心率应大于最低心率，请您重新设置！'}); 
            this.form4[this.rateClazzSetting[1].prop] = '';
          }
        }
      }else if(i == 2){
        if(b){
          if(+value > +b){
            this.$notify({type:'info',message:'平均心率应小于最高心率，请您重新设置！'}); 
            this.form4[this.rateClazzSetting[2].prop] = '';
          }
        }
        if(a){
          if(+value < +a){
            this.$notify({type:'info',message:'平均心率应大于最低心率，请您重新设置！'}); 
            this.form4[this.rateClazzSetting[2].prop] = '';
          }
        }
      }
    //阶段心率校验：
      if(i>2){
        let arr = [];
        if(this.rateClazzSetting.length>3){
          for(let k=3;k<this.rateClazzSetting.length;k++){
            arr[k-3] = this.form4[this.rateClazzSetting[k].prop];
          }
        }
        if(arr.length>0){
          let j = i-3;
          if(arr[j+1]){
            if(+arr[j]>+arr[j+1]){//前面的不能大于后面的。
              this.$notify({type:'info',message:'阶段心率的值应依次递增，请您重新设置！'}); 
              this.form4[this.rateClazzSetting[j+3].prop] = '';
            }
          }
          if(arr[j-1]){
            if(+arr[j]<+arr[j-1]){//后面的不能小于前面的。
              this.$notify({type:'info',message:'阶段心率的值应依次递增，请您重新设置！'}); 
              this.form4[this.rateClazzSetting[j+3].prop] = '';
            }
          }
        }
      }
    },
    add4(){
      this.visible4=true;
      this.title4='单个新增班级';
      this.form4 = {class_status:'启用'};
    },
    batch4(){
      if(this.cla.grade_id == undefined){
        this.$notify({
          type: 'warning',
          message: '请先选择年级，再进行批量新增操作！',
        });
      }else{
        this.visible4s=true;
      }
    },
    edit4(i,row){
      this.visible4=true;
      this.title4='班级信息修改';
      this.form4 = row;
    },
    delete4(i,row){
      this.$confirm('此操作将永久删除该条数据，是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        this.deleteByIdClazz({class_id:row.class_id}).then((result)=>{
          if(result.data.code == 200){
            this.$notify({
              title:'成功',
              type: 'success',
              message: '班级信息删除成功',
            });
            this.query();
          }else{
            console.log('班级信息删除失败，后台返回状态码：'+result.data.code);
          }
        }).catch((error)=>{
          console.log('班级信息删除失败，后台报错！-->'+error);
        });
      }).catch(() => {
        this.$notify({
          type: 'info',
          message: '已取消删除'
        });          
      });
    },
    //
    submit4(formName){
      var flag = 0;
      this.$refs[formName].validate((valid) => {
        if (valid) {
          var rate = '';
          for(var i=3;i<this.rateClazzSetting.length;i++){
            if(this.form4[this.rateClazzSetting[i].prop]){
              
            }else{
              this.form4[this.rateClazzSetting[i].prop] = '';
            }
            if(i == this.rateClazzSetting.length-1){
              rate += this.form4[this.rateClazzSetting[i].prop];
            }else{
              rate += (this.form4[this.rateClazzSetting[i].prop] + '@');
            }
          }
          this.form4.rate = rate;
          console.log(this.form4.rate);
          this.saveClazz(this.form4).then((result)=>{
            if(result.data.code == 200){
              this.$notify({
                title:'成功',
                type: 'success',
                message: '操作成功'
              }); 
              this.query();
              flag = 0;
            }else if(result.data.code == 300){
               this.$notify({
                type: 'warning',
                message: '年级下的班级名称已经存在，请重新输入！'
              });
               flag = 1;
            }else if(result.data.code == 400){
              console.log('班级设置操作失败，后台返回状态码：'+result.data.code);
              flag = 0;
            }
            console.log(flag);
             if(flag ==0){
               this.visible4=false;
            }
          }).catch((error)=>{
            console.log('班级设置操作失败，后台报错！-->'+error);
          });
         
        } else {
          console.log('error submit!!');
          return false;
        }
      });  
    },
    submit4s(){
      let obj = {
        grade_id:this.cla.grade_id,
        class_num:this.form4s.class_num,
      }
      this.batchSaveClazz(obj).then((result)=>{
        if(result.data.code == 200){
          this.$notify({
            title:'成功',
            type: 'success',
            message: '批量操作成功',
          });
          this.query();
        }else{
          console.log('班级设置批量操作失败，后台返回状态码：'+result.data.code);
        }
      }).catch((error)=>{
        console.log('班级设置批量操作失败，后台报错！-->'+error);
      });
      this.visible4s=false;
    },
    cancle4(){
      this.visible4=false;
    },
    cancle4s(){this.visible4s=false;},
    rowClass(row, index) {
      return {"background-color":"#E6EBF5",'color':'#878D99'}
    },
    query(){
      this.findClazz(this.cla).then((result)=>{
      }).catch((error)=>{
        console.log('班级信息查询失败，后台报错！-->'+error);
      });
    },
    ...mapActions(['findAllClazz','saveClazz','deleteByIdClazz','findClazz','batchSaveClazz','findRateNameClazz']),
  },
}
</script>

<style scoped>
  *{
    font-size:12px;
  }
  .clazzSetting{
    position: relative;
  }
  .icon {
    cursor: pointer;
    font-size: 18px;
  }
  .table{
    position: absolute;
    left: 0px;
    right: 0px;
    /*overflow: scroll;*/
  }
  .table .el-table-column{
    text-align: center;
  }
  /* .dialog .el-input{
    width:440px;
  } */
  .dialog-footer{
    text-align:right;
  }
  .rowTop .el-form .el-form-item{
    margin-top:-3px;
    margin-bottom:11px;
  }
  .rowTop .but{
    margin-right:0;
    margin-left:8px;
  } 
  .search{
    background: #448db8;
    border:none;
  }
  .add{
    background: #448db8;
    border:none;
  }
  .adds{
    background: #448db8;
    border:none;
  }
  .yes{
    background: #448db8;
    border:none;
  }
  .clazzSetting i.options{
  padding: 0 5px;
  cursor: pointer;
  color: #448db8;
}

</style>
<style>
   /*模态框样式*/
  .dialog-title {
    background-color: #448db8;
    height: 52px;
    line-height: 52px;
    font-size: 18px;
    color: #FFF;
  }
  .el-dialog__headerbtn i.el-dialog__close {
    color: #FFF;
  }
  div.el-dialog__header {
    padding: 0;
  }
  div.el-dialog--center .el-dialog__header {
    padding-top: 0
  }
</style>
